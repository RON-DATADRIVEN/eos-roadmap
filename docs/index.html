<!doctype html>
<html lang="es" data-issue-service-url="https://create-issue-rondatadriven.uc.r.appspot.com">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EOS ‚Äì Roadmap p√∫blico</title>
  <meta name="description" content="Evoluci√≥n de m√≥dulos de la plataforma EOS " />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="header-main">
        <div>
          <h1>EOS ‚Äì Roadmap p√∫blico</h1>
          <p>
            Seguimiento de m√≥dulos y estado.
            <a class="link" href="https://github.com/orgs/RON-DATADRIVEN/projects/3/views/1?layout=board" target="_blank" rel="noopener">Ver plan en completo en GitHub Projects</a>
          </p>
        </div>
        <button id="openIssueModal" class="btn" type="button" aria-haspopup="dialog" aria-controls="issueModal">Crear issue</button>
      </div>
    </div>
  </div>

  <main class="container">
    <section class="controls">
      <select id="statusFilter" aria-label="Filtrar por estado">
        <option value="">Todos los estados</option>
        <option value="Planificado">Planificado</option>
        <option value="En curso">En curso</option>
        <option value="Hecho">Hecho</option>
      </select>
      <input id="search" type="search" placeholder="Buscar m√≥dulo..." />
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>

    <div class="footer" id="footer"></div>
  </main>

  <div
    id="issue-modal-root"
    data-issue-beacon-url="https://script.google.com/macros/s/AKfycbzWjd8Q6sIUjI_H_vlglkq3ma4mn2fbtEga66qCswHuAUsYmLjXS-wRdZAyi2rsWhl2tg/exec"
  >
    <div id="issueModalOverlay" class="modal-overlay hidden" role="presentation">
      <div
        id="issueModal"
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="issueModalTitle"
        aria-describedby="issueModalDescription"
        tabindex="-1"
      >
      <button id="closeIssueModal" type="button" class="modal-close" aria-label="Cerrar">
        √ó
      </button>
      <h2 id="issueModalTitle">Crear issue</h2>
      <p id="issueModalDescription" class="modal-description">Selecciona una plantilla para generar el contenido del issue.</p>
      <div class="modal-body">
        <aside class="template-selector" aria-label="Plantillas de issue">
          <h3>Plantillas</h3>
          <ul id="templateList" class="template-list" role="list"></ul>
        </aside>
        <section class="template-form" aria-live="polite">
          <div class="template-meta">
            <p id="templateSummary" class="template-summary"></p>
            <div id="issueLabels" class="issue-labels" aria-label="Etiquetas aplicadas"></div>
          </div>
          <form id="issueForm" novalidate>
            <div class="field">
              <label for="issueTitle">T√≠tulo</label>
              <input id="issueTitle" name="issueTitle" type="text" required />
            </div>
            <div id="issueFields" class="field-group"></div>
            <div class="form-actions">
              <button id="submitIssue" type="submit" class="btn primary">Crear issue</button>
            </div>
          </form>
          <div id="issueFormMessage" class="form-message" role="alert" aria-live="assertive"></div>
          <pre id="payloadPreview" class="payload-preview hidden" tabindex="0" aria-label="Vista previa del cuerpo del issue"></pre>
        </section>
      </div>
      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const statusFilter = document.getElementById('statusFilter');
    const search = document.getElementById('search');
    const footer = document.getElementById('footer');
    const openIssueModalBtn = document.getElementById('openIssueModal');
    const modalOverlay = document.getElementById('issueModalOverlay');
    const issueModal = document.getElementById('issueModal');
    const closeIssueModalBtn = document.getElementById('closeIssueModal');
    const templateList = document.getElementById('templateList');
    const templateSummary = document.getElementById('templateSummary');
    const issueLabels = document.getElementById('issueLabels');
    const issueForm = document.getElementById('issueForm');
    const issueFields = document.getElementById('issueFields');
    const issueTitle = document.getElementById('issueTitle');
    const issueFormMessage = document.getElementById('issueFormMessage');
    const payloadPreview = document.getElementById('payloadPreview');

    function getBeaconUrl() {
      // Poka-yoke: buscamos un elemento con el atributo data-issue-beacon-url para que la URL quede documentada directamente en el HTML y cualquiera pueda ubicarla.
      const dataElement = document.querySelector('[data-issue-beacon-url]');
      const domValue = dataElement ? (dataElement.getAttribute('data-issue-beacon-url') || '').trim() : '';
      if (domValue) {
        return domValue;
      }

      // Poka-yoke: si el HTML no define la ruta, consultamos una variable global opcional para conservar compatibilidad con despliegues anteriores.
      const windowValue = typeof window !== 'undefined' && window.ISSUE_BEACON_URL ? String(window.ISSUE_BEACON_URL).trim() : '';
      if (windowValue) {
        return windowValue;
      }

      // Poka-yoke: al no encontrar ninguna configuraci√≥n devolvemos un error expl√≠cito para guiar a la persona usuaria a solicitar soporte.
      throw new Error('ISSUE_BEACON_URL no configurado. Contacta al administrador para continuar.');
    }

    let modules = [];
    let currentTemplateId = null;
    let lastFocusedElement = null;

    const issueTemplates = [
      {
        id: 'blank',
        name: 'üóø Issue',
        description: 'Issue libre con estructura m√≠nima',
        title: '[ISSUE] T√≠tulo',
        labels: ['Status: Ideas', 'Tipo :Blank Issue'],
        body: [
          {
            type: 'textarea',
            id: 'descripcion',
            label: 'Descripci√≥n',
            placeholder: 'Escribe aqu√≠‚Ä¶',
            value: '**Contexto**\n-\n\n**Detalles**\n-\n\n**Criterio de aceptaci√≥n**\n-'
          }
        ]
      },
      {
        id: 'bug',
        name: 'üêû Bug',
        description: 'Reportar un defecto',
        title: 'fix: <resumen>',
        labels: ['Tipo: Bug', 'Status :En planeaci√≥n'],
        body: [
          {
            type: 'input',
            id: 'summary',
            label: 'Resumen',
            placeholder: 'Error 500 al crear programa',
            required: true
          },
          {
            type: 'textarea',
            id: 'steps',
            label: 'Pasos para reproducir',
            placeholder: '1. Ir a /programas ‚Üí 2. Click en crear ‚Üí 3. ...',
            required: true
          },
          {
            type: 'textarea',
            id: 'expected',
            label: 'Comportamiento esperado',
            required: true
          },
          {
            type: 'textarea',
            id: 'actual',
            label: 'Comportamiento actual',
            required: true
          },
          {
            type: 'textarea',
            id: 'env',
            label: 'Entorno',
            placeholder: 'Prod/Stg/Dev, navegador, versi√≥n'
          },
          {
            type: 'textarea',
            id: 'logs',
            label: 'Logs/evidencia'
          }
        ]
      },
      {
        id: 'change_request',
        name: 'üìù Solicitud de Cambio',
        description: 'Solicitar un cambio de alcance/alcance t√©cnico',
        title: 'chore: change-request <resumen>',
        labels: ['Tipo: Change Request', 'Status: Ideas'],
        body: [
          {
            type: 'markdown',
            id: 'intro',
            value: 'Describe el cambio propuesto y el impacto (tiempo, costo, riesgo). Ser√° evaluado.'
          },
          {
            type: 'textarea',
            id: 'description',
            label: 'Descripci√≥n del cambio',
            required: true
          },
          {
            type: 'textarea',
            id: 'impact',
            label: 'Impacto (alcance/tiempo/costo/riesgo)',
            required: true
          },
          {
            type: 'input',
            id: 'requester',
            label: 'Solicitante',
            placeholder: '@stakeholder',
            required: true
          }
        ]
      },
      {
        id: 'feature',
        name: '‚öô Feature',
        description: 'Nueva capacidad o mejora',
        title: '[FEAT] T√≠tulo de la feature',
        labels: ['Tipo: Feature', 'Status: Ideas'],
        body: [
          {
            type: 'textarea',
            id: 'descripcion',
            label: 'Descripci√≥n',
            placeholder: 'Como [rol] quiero [funci√≥n] para [beneficio]',
            required: true
          },
          {
            type: 'input',
            id: 'criterio',
            label: 'Criterio de aceptaci√≥n (resumen)',
            placeholder: 'Dado/Cuando/Entonces...',
            required: true
          }
        ]
      }
    ];

    function renderTemplateOptions() {
      templateList.innerHTML = '';
      issueTemplates.forEach(template => {
        const item = document.createElement('li');
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'template-option';
        button.dataset.templateId = template.id;

        const name = document.createElement('span');
        name.className = 'template-name';
        name.textContent = template.name;

        const description = document.createElement('span');
        description.className = 'template-option-description';
        description.textContent = template.description;

        button.append(name, description);
        button.addEventListener('click', () => selectTemplate(template.id));

        item.appendChild(button);
        templateList.appendChild(item);
      });
    }

    function selectTemplate(templateId) {
      const template = issueTemplates.find(t => t.id === templateId);
      if (!template) {
        return;
      }

      currentTemplateId = templateId;

      templateList.querySelectorAll('.template-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.templateId === templateId);
      });

      templateSummary.textContent = template.description;
      issueLabels.innerHTML = '';
      template.labels.forEach(label => {
        const badge = document.createElement('span');
        badge.className = 'label-chip';
        badge.textContent = label;
        issueLabels.appendChild(badge);
      });

      payloadPreview.classList.add('hidden');
      payloadPreview.textContent = '';
      clearMessage();

      populateTemplateFields(template);
    }

    function populateTemplateFields(template) {
      issueTitle.value = template.title;
      issueTitle.placeholder = template.title;

      issueFields.innerHTML = '';
      template.body.forEach(field => {
        if (field.type === 'markdown') {
          const wrapper = document.createElement('div');
          wrapper.className = 'field markdown';
          wrapper.dataset.type = 'markdown';
          wrapper.dataset.value = field.value || '';

          const label = document.createElement('p');
          label.className = 'markdown-hint';
          label.textContent = field.value || '';
          wrapper.appendChild(label);

          issueFields.appendChild(wrapper);
          return;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'field';
        wrapper.dataset.type = field.type;
        wrapper.dataset.fieldId = field.id;
        wrapper.dataset.label = field.label || field.id;

        const label = document.createElement('label');
        label.textContent = field.label || field.id;

        const controlId = `issue-field-${template.id}-${field.id}`;

        let control;
        if (field.type === 'textarea') {
          control = document.createElement('textarea');
          control.rows = 4;
        } else {
          control = document.createElement('input');
          control.type = 'text';
        }

        control.id = controlId;
        control.name = field.id;
        control.placeholder = field.placeholder || '';
        if (field.required) {
          control.required = true;
          wrapper.classList.add('required');
        }
        if (field.value) {
          control.value = field.value;
        }

        label.setAttribute('for', controlId);

        control.addEventListener('input', () => {
          wrapper.classList.remove('invalid');
        });
        control.addEventListener('blur', () => {
          if (control.required && !control.value.trim()) {
            wrapper.classList.add('invalid');
          }
        });

        wrapper.append(label, control);
        issueFields.appendChild(wrapper);
      });
    }

    function readIssueForm() {
      // Poka-yoke: localizamos la plantilla activa para garantizar que los datos sigan la estructura acordada.
      const template = issueTemplates.find(t => t.id === currentTemplateId);
      if (!template) {
        return null;
      }

      // Poka-yoke: usamos FormData para leer todos los campos sin depender de nombres hardcodeados.
      const formData = new FormData(issueForm);
      const sanitizedTitle = (formData.get('issueTitle') || '').trim();

      // Poka-yoke: preparamos recipientes claros para cada tipo de informaci√≥n que espera Apps Script.
      const fieldValues = {};
      const sections = [];
      const labels = new Set(Array.isArray(template.labels) ? template.labels : []);

      template.body.forEach(field => {
        if (field.type === 'markdown') {
          // Poka-yoke: respetamos el contenido fijo de la plantilla para que nunca se pierda contexto al enviar el issue.
          if (field.value) {
            sections.push(field.value);
          }
          return;
        }

        const rawValue = formData.get(field.id);
        const value = (rawValue || '').trim();

        if (value || field.required) {
          // Poka-yoke: almacenamos el valor incluso vac√≠o cuando es obligatorio para detectar omisiones en integraciones futuras.
          fieldValues[field.id] = value;
        }

        if (value) {
          const label = field.label || field.id;
          // Poka-yoke: generamos bloques Markdown ordenados para que quien reciba el reporte lo lea sin ambig√ºedades.
          sections.push(`### ${label}\n${value}`);
        }
      });

      const markdownBody = sections.join('\n\n').trim();

      return {
        template,
        title: sanitizedTitle,
        body: markdownBody,
        labels: Array.from(labels),
        fields: fieldValues
      };
    }

    function toIssuePayload(formState) {
      if (!formState) {
        return null;
      }

      const templateId = formState.template && typeof formState.template === 'object' ? formState.template.id : formState.template;

      const payload = {
        // Poka-yoke: normalizamos t√≠tulo y cuerpo para evitar que lleguen espacios o valores nulos al Apps Script.
        title: (formState.title || '').trim(),
        body: formState.body || '',
        labels: Array.isArray(formState.labels) ? formState.labels : [],
        template: templateId || 'blank',
        extra: {
          // Poka-yoke: agrupamos los campos originales para poder reconstruir el formulario en caso de auditor√≠as.
          fields: formState.fields || {}
        }
      };

      if (formState.template && formState.template.name) {
        // Poka-yoke: adjuntamos el nombre humano de la plantilla para facilitar las revisiones manuales en el documento.
        payload.extra.templateName = formState.template.name;
      }

      return payload;
    }

    function submitViaHiddenForm(url, payload) {
      // Poka-yoke: intentamos reutilizar un formulario oculto existente para no crear duplicados innecesarios.
      let form = document.getElementById('beacon-fallback-form');
      let sink = document.getElementById('beacon-fallback-sink');

      if (!form) {
        // Poka-yoke: creamos un formulario m√≠nimo sin estilos visibles para asegurar el env√≠o a√∫n sin sendBeacon.
        form = document.createElement('form');
        form.id = 'beacon-fallback-form';
        form.method = 'POST';
        form.action = url;
        form.target = 'beacon-fallback-sink';
        form.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'payload';
        input.id = 'beacon-fallback-payload';
        form.appendChild(input);

        document.body.appendChild(form);
      }

      if (!sink) {
        // Poka-yoke: a√±adimos un iframe invisible que recibir√° la respuesta y evitar√° recargas accidentales.
        sink = document.createElement('iframe');
        sink.name = 'beacon-fallback-sink';
        sink.id = 'beacon-fallback-sink';
        sink.style.display = 'none';
        document.body.appendChild(sink);
      }

      const payloadInput = document.getElementById('beacon-fallback-payload');
      if (payloadInput) {
        // Poka-yoke: convertimos el JSON a texto para que Apps Script lo reciba igual que sendBeacon.
        payloadInput.value = JSON.stringify(payload);
        form.submit();
      }
    }

    function showMessage(message, variant = 'info', options = {}) {
      issueFormMessage.textContent = '';
      issueFormMessage.className = `form-message ${variant}`;

      if (message) {
        issueFormMessage.append(document.createTextNode(message));
      }

      if (options.debugId) {
        // Adjuntamos el identificador para que soporte pueda solicitarlo sin
        // exponer detalles t√©cnicos al usuario final.
        const debugLine = document.createElement('div');
        debugLine.classList.add('form-message-debug');
        debugLine.textContent = `C√≥digo de seguimiento: ${options.debugId}`;
        issueFormMessage.append(debugLine);
      }

      const link = options.link || options;
      if (link && link.href && link.label) {
        const anchor = document.createElement('a');
        anchor.href = link.href;
        anchor.target = '_blank';
        anchor.rel = 'noreferrer noopener';
        anchor.textContent = link.label;
        anchor.classList.add('form-message-link');
        issueFormMessage.append(document.createTextNode(' '));
        issueFormMessage.append(anchor);
      }
    }

    function clearMessage() {
      issueFormMessage.textContent = '';
      issueFormMessage.className = 'form-message';
    }

    function getFocusableElements() {
      return Array.from(issueModal.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'));
    }

    function trapFocus(event) {
      if (event.key !== 'Tab') {
        return;
      }

      const focusable = getFocusableElements();
      if (!focusable.length) {
        return;
      }

      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    }

    function handleKeydown(event) {
      // Poka-yoke: detectamos Escape para cerrar de inmediato y Tab para mantener el enfoque dentro del modal sin sorpresas.
      if (event.key === 'Escape') {
        closeIssueModal();
        return;
      }
      trapFocus(event);
    }

    function openIssueModal() {
      // Poka-yoke: validamos el estado antes de abrir para evitar que la animaci√≥n se dispare m√∫ltiples veces o que el foco quede atrapado sin modal visible.
      if (modalOverlay.classList.contains('hidden')) {
        lastFocusedElement = document.activeElement;
        modalOverlay.classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.addEventListener('keydown', handleKeydown);

        clearMessage();
        payloadPreview.classList.add('hidden');
        payloadPreview.textContent = '';

        if (!currentTemplateId && issueTemplates.length) {
          selectTemplate(issueTemplates[0].id);
        }

        requestAnimationFrame(() => {
          const focusable = getFocusableElements();
          (focusable[0] || issueModal).focus();
        });
      }
    }

    function closeIssueModal() {
      // Poka-yoke: evitamos cerrar si ya est√° oculto para impedir cambios de estado inconsistentes.
      if (!modalOverlay.classList.contains('hidden')) {
        modalOverlay.classList.add('hidden');
        document.body.classList.remove('modal-open');
        document.removeEventListener('keydown', handleKeydown);
        if (lastFocusedElement) {
          lastFocusedElement.focus();
        }
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      clearMessage();

      if (!currentTemplateId) {
        showMessage('Selecciona una plantilla para continuar.', 'error');
        return;
      }

      if (!issueForm.reportValidity()) {
        const invalid = issueForm.querySelector(':invalid');
        if (invalid) {
          const field = invalid.closest('.field');
          if (field) {
            field.classList.add('invalid');
          }
          invalid.focus();
        }
        return;
      }

      const formState = readIssueForm();
      if (!formState) {
        showMessage('Plantilla no disponible.', 'error');
        return;
      }

      if (!formState.title) {
        issueTitle.focus();
        showMessage('El t√≠tulo es obligatorio.', 'error');
        return;
      }

      const payload = toIssuePayload(formState);
      if (!payload) {
        showMessage('No fue posible preparar el issue.', 'error');
        return;
      }

      payloadPreview.textContent = payload.body || 'Sin contenido';
      payloadPreview.classList.toggle('hidden', !payload.body);

      let beaconUrl;
      try {
        // Poka-yoke: resolvemos la URL mediante la funci√≥n centralizada para evitar discrepancias entre ambientes.
        beaconUrl = getBeaconUrl();
      } catch (error) {
        showMessage(error instanceof Error ? error.message : 'ISSUE_BEACON_URL no configurado.', 'error');
        return;
      }

      const serializedPayload = JSON.stringify(payload);

      // Poka-yoke: activamos de inmediato el formulario oculto para asegurar un POST simple incluso si el beacon es bloqueado.
      submitViaHiddenForm(beaconUrl, payload);

      try {
        // Poka-yoke: usamos sendBeacon de forma complementaria cuando existe porque permite mandar la informaci√≥n aunque la pesta√±a se cierre.
        if (typeof navigator !== 'undefined' && typeof navigator.sendBeacon === 'function') {
          navigator.sendBeacon(beaconUrl, serializedPayload);
        }
      } catch (error) {
        console.error('sendBeacon no pudo ejecutarse.', error);
      } finally {
        // Poka-yoke: cerramos y limpiamos el modal para que no queden datos sensibles expuestos aunque el env√≠o falle.
        closeModal();
        issueForm.reset();
        payloadPreview.classList.add('hidden');
        payloadPreview.textContent = '';
        if (formState.template) {
          populateTemplateFields(formState.template);
        }
      }
    }

    renderTemplateOptions();
    if (issueTemplates.length) {
      selectTemplate(issueTemplates[0].id);
    }

    openIssueModalBtn.addEventListener('click', openIssueModal);
    closeIssueModalBtn.addEventListener('click', closeIssueModal);
    modalOverlay.addEventListener('click', event => {
      if (event.target === modalOverlay) {
        closeIssueModal();
      }
    });
    issueForm.addEventListener('submit', handleSubmit);

    async function load() {
      try {
        const res = await fetch('modules.json', { cache: 'no-store' });
        modules = await res.json();
        render();
      } catch (e) {
        grid.innerHTML = '<p>No se pudo cargar <code>modules.json</code>. Verifica GitHub Pages.</p>';
      }
      footer.textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString()}`;
    }

    function badgeClass(estado) {
      if (!estado) return 'badge';
      const key = estado.toLowerCase().replace(/\s+/g,'');
      return `badge ${key}`;
    }

    function render() {
      const term = search.value.trim().toLowerCase();
      const st = statusFilter.value;
      const filtered = modules.filter(m => {
        const matchStatus = !st || m.estado === st;
        const matchText = !term || (m.nombre + ' ' + (m.descripcion||'')).toLowerCase().includes(term);
        const isEpic = m.tipo === 'epic';
        return matchStatus && matchText && isEpic;
      });

      grid.innerHTML = filtered.map(m => `
        <article class="card">
          <h3>${m.nombre}</h3>
          <span class="${badgeClass(m.estado)}">${m.estado||''}</span>
          <p class="desc">${m.descripcion||''}</p>
          <div class="progress" title="${m.porcentaje||0}%">
            <div style="width:${Math.min(100, Math.max(0, m.porcentaje||0))}%"></div>
          </div>
          <div class="meta">
            <span>Propietario: ${m.propietario||'‚Äî'}</span>
            <span>Inicio: ${m.inicio||'‚Äî'}</span>
            <span>ETA: ${m.eta||'‚Äî'}</span>
            <span>Progreso: ${m.porcentaje||0}%</span>
          </div>
          ${Array.isArray(m.enlaces) && m.enlaces.length ? (`<div class="meta">` + m.enlaces.map(e => `<a class="link" href="${e.url}" target="_blank" rel="noopener">${e.label}</a>`).join(' ¬∑ ') + `</div>`) : ''}
        </article>
      `).join('');

      if (!filtered.length) {
        grid.innerHTML = '<p>No hay m√≥dulos con  ese filtro/b√∫squeda.</p>';
      }
    }

    statusFilter.addEventListener('change', render);
    search.addEventListener('input', render);

    load();
  </script>
</body>
</html>
